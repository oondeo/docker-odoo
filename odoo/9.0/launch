#!/bin/bash

# This program patches the configuration for Odoo and then runs the server

conf=/etc/odoo/openerp-server.conf
odoo="$ODOO_SERVER --config $conf"

# Ensure proper content for $UNACCENT
if [ "$UNACCENT" != "True" ]; then
    UNACCENT=False
fi

echo Patching configuration > /dev/stderr

# Fix usual permissions issues with extra addons if there's write permission
[ -w /opt/odoo/extra-addons ] && \
    chmod --recursive u=rwX,go=rX /opt/odoo/extra-addons

addons=$(ls -1bd /usr/lib/python2.7/site-packages/openerp/addons \
                 /opt/odoo/extra-addons/* | tr '\n' ',' | sed s/,$//)

echo "
[options]
; Configuration file generated by $(readlink --canonicalize $0)
addons_path = " $addons "
unaccent = $UNACCENT
db_host = $DB_PORT_5432_TCP_ADDR
db_port = $DB_PORT_5432_TCP_PORT
db_user = ${DB_ENV_POSTGRES_USER:=postgres}
db_password = $DB_ENV_POSTGRES_PASSWORD
admin_passwd = $ADMIN_PASSWORD" > $conf

# If database is available, use it
if [ "$DATABASE" != "" ]; then
    echo "database = $DATABASE" >> $conf
fi

# Allow Odoo to write in its folders (needed if you mounted them)
chown --recursive odoo:odoo /var/{lib,log}/odoo /home/odoo

# Know if Postgres is listening
function db_is_listening() {
    sleep 1
    PGPASSWORD="$DB_ENV_POSTGRES_PASSWORD" psql \
        --user "${DB_ENV_POSTGRES_USER:=postgres}" \
        --host "$DB_PORT_5432_TCP_ADDR" \
        --port "$DB_PORT_5432_TCP_PORT" \
        --list > /dev/null 2>&1 || db_is_listening
}

echo Waiting until the database server is listening... > /dev/stderr
db_is_listening

# Add the unaccent module for the database if needed
if [ "$DATABASE" != "" ] && [ "$UNACCENT" == "True" ]; then
    echo Trying to install unaccent extension > /dev/stderr

    PGPASSWORD="$DB_ENV_POSTGRES_PASSWORD" psql \
        --user "${DB_ENV_POSTGRES_USER:=postgres}" \
        --host "$DB_PORT_5432_TCP_ADDR" \
        --port "$DB_PORT_5432_TCP_PORT" \
        --dbname "$DATABASE" \
        --command 'CREATE EXTENSION IF NOT EXISTS unaccent;'
fi

# Run server
echo Executing \'$odoo\' > /dev/stderr
su odoo --command "$odoo"
