#!/bin/bash

# This program patches the configuration for Odoo and then runs the server

conf=/etc/openerp/openerp-server.conf
odoo="$ODOO_SERVER --config $conf"

# Ensure proper content for $UNACCENT
if [ "$UNACCENT" != "True" ]; then
    UNACCENT=False
fi

# Patches for first run
if [ -f /firstrun ]; then
    echo Patching configuration on first run > /dev/stderr

    addons=$(ls -1bd /usr/local/lib/python2.7/dist-packages/openerp/addons \
                     /opt/odoo/extra-addons/* | tr '\n' ',' | sed s/,$//)

    echo "
[options]
; Configuration file generated by $(readlink --canonicalize $0)
addons_path = " $addons "
unaccent = $UNACCENT
db_host = $DB_PORT_5432_TCP_ADDR
db_port = $DB_PORT_5432_TCP_PORT
db_user = $DB_ENV_USER
db_password = $DB_ENV_PASSWORD
admin_passwd = $ADMIN_PASSWD" > $conf

    # If database is available, use it
    if [ "$DATABASE" != "" ]; then
        echo "database = $DATABASE" >> $conf

        # Add the unaccent module for the database if needed
        if [ "$UNACCENT" == "True" ]; then
            PGPASSWORD="$DB_ENV_PASSWORD" psql \
                --user "$DB_ENV_USER" \
                --host "$DB_PORT_5432_TCP_ADDR" \
                --port "$DB_PORT_5432_TCP_PORT" \
                --dbname "$DATABASE" \
                --command 'CREATE EXTENSION unaccent;'
        fi
    fi

    rm /firstrun
fi

# Run server
echo "Executing '$odoo'" > /dev/stderr
su odoo --command "$odoo"
