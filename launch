#!/bin/bash

# This program patches the configuration for Odoo and then runs the server

source $(dirname $0)/variables

conf=/etc/openerp/openerp-server.conf
odoo="$ODOO_SERVER --config $conf"

if [ -f /firstrun ]; then
    echo Patching configuration on first run

    addons=$(ls -1bd /usr/local/lib/python2.7/dist-packages/openerp/addons \
                     /opt/odoo/extra-addons/* | tr '\n' ',' | sed s/,$//)

    echo "
[options]
; Configuration file generated by $(readlink --canonicalize $0)
addons_path = " $addons "
unaccent = True
db_host = $DB_PORT_5432_TCP_ADDR
db_port = $DB_PORT_5432_TCP_PORT
db_user = $DB_ENV_POSTGRESQL_USER
db_password = $DB_ENV_POSTGRESQL_PASS
database = $DB_ENV_POSTGRESQL_DB
admin_passwd = $ADMIN_PASSWD" > $conf

    rm /firstrun
fi

# Prepare connections to the database
export PGPASSWORD="$DB_ENV_POSTGRESQL_PASS"
pg="$(echo psql \
     --user "$DB_ENV_POSTGRESQL_USER" \
     --host "$DB_PORT_5432_TCP_ADDR" \
     --port "$DB_PORT_5432_TCP_PORT" \
     --dbname "$DB_ENV_POSTGRESQL_DB" \
     --command)"

# Install unaccent
$pg 'CREATE EXTENSION unaccent;'

# This will have 4 lines for an empty database
if [ $($pg 'SELECT * FROM pg_stat_user_tables;' | wc -l) -lt 5 ]; then
    # Workaround of for web module not being installed
    # https://github.com/odoo/odoo/issues/953#issuecomment-54597695
    odoo="$odoo --init base,web --database '$DB_ENV_POSTGRESQL_DB'"
fi

# Run server
echo "Executing '$odoo'"
su odoo --command "$odoo"
